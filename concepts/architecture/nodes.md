# 节点

Kubernetes通过将容器放入Pods中以在Nodes上运行来运行您的工作负载。 取决于群集，节点可以是虚拟机或物理机。 每个节点都由控制平面管理，并包含运行Pods所需的服务

通常，您在一个集群中有多个节点。 在学习或资源有限的环境中，您可能只有一个节点。

节点上的组件包括kubelet，容器运行时和kube-proxy。

## 管理

将节点添加到API服务器的主要方法有两种：

1. 节点上的kubelet自动注册到控制平面
2. 手动添加Node对象

创建Node对象或节点上的kubelet自注册后，控制平面将检查新的Node对象是否有效。 例如，如果您尝试从以下JSON清单创建节点：

```code
{
  "kind": "Node",
  "apiVersion": "v1",
  "metadata": {
    "name": "10.240.79.157",
    "labels": {
      "name": "my-first-k8s-node"
    }
  }
}
```

Kubernetes在内部创建一个Node对象（表示形式）。 Kubernetes会检查kubelet是否已注册到与Node的metadata.name字段匹配的API服务器。 如果节点运行状况良好（即所有必需的服务都在运行），则可以运行Pod。 否则，该节点的任何群集活动都将被忽略，直到它变得健康为止。

注意：
Kubernetes将对象保留为无效的Node并继续检查以查看其是否健康。

您或控制器必须显式删除Node对象才能停止运行状况检查。

Node对象的名称必须是有效的DNS子域名。

### 节点名称唯一性

该名称标识一个节点。 两个节点不能同时具有相同的名称。 Kubernetes还假定具有相同名称的资源是同一对象。 如果是节点，则隐式假定使用相同名称的实例将具有相同的状态（例如，网络设置，根磁盘内容）。 如果在不更改实例名称的情况下对其进行了修改，则可能导致不一致。 如果需要大量替换或更新Node，则需要先从API服务器中删除现有的Node对象，并在更新后重新添加。

### 节点自行注册

当kubelet标志--register-node为true（默认设置）时，kubelet将尝试向API服务器注册自身。 这是大多数发行版使用的首选模式。

对于自我注册，kubelet使用以下选项启动：

* `--kubeconfig`: 用于向API服务器进行身份验证的凭据的路径
* `--cloud-provider`: 如何与云提供商交谈以读取有关其自身的元数据。
* `--register-node`: 自动向API服务器注册。
* `--register-with-taints`: 用给定的污点列表（用逗号分隔的`key= value:effect`）注册该节点。
* `--node-ip`: 节点的IP地址。
* `--node-labels`: 在集群中注册节点时要添加的标签（请参阅由NodeRestriction允许插件实施的标签限制）。
* `--node-status-update-frequency`: 指定kubelet多久将一次节点状态发布到主节点。

启用节点授权模式和NodeRestriction允许插件时，仅授权kubelet创建/修改其自己的Node资源。

### 手动节点管理

您可以使用kubectl创建和修改Node对象。

当您要手动创建Node对象时，请设置kubelet标志--register-node = false。

无论--register-node的设置如何，都可以修改Node对象。 例如，您可以在现有节点上设置标签或将其标记为不可计划。

您可以结合使用节点上的标签和Pod上的节点选择器来控制调度。 例如，您可以将Pod限制为只能在可用节点的子集上运行。

将节点标记为不可调度可防止调度程序将新的容器放置到该节点上，但不会影响该节点上的现有容器。 这对于节点重新引导或其他维护之前的准备步骤很有用。

要将节点标记为不可调度，请运行：

```code
kubectl cordon $NODENAME

```

注意：作为DaemonSet一部分的Pod允许在无法调度的节点上运行。 守护程序集通常提供应在节点上运行的节点本地服务，即使正在耗尽工作负载应用程序也是如此。

## 节点状态

节点的状态包含以下信息：

* 地址
* 状态
* 可用性和可分配性
* 信息

可以使用`kubectl`查看节点的状态和其他信息：`kubectl describe node <insert-node-name-here>`

输出的每个部分如下所述:

### 地址

这些字段的用法因您的云提供商或裸机配置而异：

* HostName： 节点内核报告的主机名。 可以通过kubelet --hostname-override参数覆盖。
* ExternalIP： 通常，可外部路由的节点的IP地址（可从群集外部获得）
* InternalIP： 通常，仅在群集内可路由的节点的IP地址。

### 状态

条件字段描述所有正在运行的节点的状态。 条件的示例包括：

| 节点状态             | 描述                                                         |
| -------------------- | ------------------------------------------------------------ |
| `Ready`              | 如果节点运行状况良好并准备好接受Pod，则为True；如果节点运行状况不佳且不接受Pod，则为false；如果节点控制器未从上一个节点监视程序中的节点收到消息，则为Unknown。 -grace-period`（默认值为40秒） |
| `DiskPressure`       | 如果磁盘大小存在压力，即磁盘容量低，则为True。 否则为False   |
| `MemoryPressure`     | 如果节点内存上存在压力（即节点内存不足），则为True。 否则为False |
| `PIDPressure`        | 如果进程上存在压力，即节点上的进程太多，则为“真”。 否则为False |
| `NetworkUnavailable` | 如果未正确配置节点的网络，则为True；否则为False。            |

注意：如果使用命令行工具来打印封闭节点的详细信息，则条件包括SchedulingDisabled。 在Kubernetes API中，SchedulingDisabled不是条件; 相反，警戒节点在其规范中标记为“不可调度”。

节点状态表示为JSON对象。 例如，以下结构描述了一个健康的节点：

```json
"conditions": [
  {
    "type": "Ready",
    "status": "True",
    "reason": "KubeletReady",
    "message": "kubelet is posting ready status",
    "lastHeartbeatTime": "2019-06-05T18:38:35Z",
    "lastTransitionTime": "2019-06-05T11:41:27Z"
  }
]
```

如果“就绪”状态的状态保持“未知”或“假”的时间超过pod-eviction-timeout（传递给kube-controller-manager的参数）的时间，则该节点上的所有Pod都已安排好由节点控制器删除。默认逐出超时持续时间为五分钟。在某些情况下，当节点不可访问时，API服务器将无法与节点上的kubelet通信。在重新建立与API服务器的通信之前，无法将删除pod的决定传达给kubelet。同时，计划删除的Pod可能会继续在分区节点上运行。

在确认节点已停止在集群中运行之前，节点控制器不会强制其删除。您可以看到可能在不可达节点上运行的Pod处于“正在终止”或“未知”状态。如果Kubernetes无法从基础架构推断出某个节点永久离开集群的情况，则集群管理员可能需要手动删除该节点对象。从Kubernetes删除节点对象会导致节点上运行的所有Pod对象从API服务器中删除，并释放它们的名称。

节点生命周期控制器会自动创建代表条件的污点。在将Pod分配给节点时，调度程序会考虑节点的污点。 Pod也可以具有容忍度，以使它们可以容忍Node的污点。

有关更多详细信息，请参见按条件污染节点。

### 可用性和可分配性

描述节点上可用的资源：CPU，内存以及可以调度到节点上的Pod的最大数量。

容量块中的字段指示节点拥有的资源总数。 可分配块指示节点上可供普通Pod消耗的资源量。

在学习如何在节点上保留计算资源的同时，您可以阅读有关容量和可分配资源的更多信息。

### 信息

描述有关节点的常规信息，例如内核版本，Kubernetes版本（kubelet和kube-proxy版本），Docker版本（如果使用）和操作系统名称。 该信息由Kubelet从节点收集。

### 节点控制器

节点控制器是Kubernetes控制平面组件，用于管理节点的各个方面。

节点控制器在节点的生命中扮演多个角色。 第一个是在注册节点时将CIDR块分配给该节点（如果CIDR分配已打开）。

第二个是使节点控制器的内部节点列表与云提供商的可用计算机列表保持最新。 在云环境中运行时以及每当节点运行不正常时，节点控制器都会询问云提供商，该节点的VM是否仍然可用。 如果不是，则节点控制器从其节点列表中删除该节点。

第三是监视节点的运行状况。 节点控制器负责：

* 当节点变得不可访问时，将NodeStatus的NodeReady条件更新为ConditionUnknown，因为节点控制器由于某种原因（例如，节点已关闭）而停止接收心跳。
* 如果节点仍然无法访问，请使用正常终止从节点中逐出所有Pod。 默认超时为40秒，开始报告ConditionUnknown，之后为5m，开始驱逐Pod。

节点控制器每隔--node-monitor-period秒检查一次每个节点的状态。

### 心跳

Kubernetes节点发送的心跳有助于确定节点的可用性。

心跳有两种形式：更新NodeStatus和Lease对象。 每个节点在kube-node-lease命名空间中都有一个关联的Lease对象。 租用是一种轻量级的资源，可在群集扩展时提高节点心跳的性能。

kubelet负责创建和更新NodeStatus和Lease对象。

* 当状态发生变化或在配置的时间间隔内没有更新时，kubelet会更新NodeStatus。 NodeStatus更新的默认间隔为5分钟，比无法访问的节点的40秒默认超时长得多。
* Kubelet会每10秒（默认更新间隔）创建并更新其Lease对象。 租赁更新独立于NodeStatus更新发生。 如果“租约”更新失败，则kubelet将从200毫秒开始以指数退避重试，并以7秒为上限。

### 可靠性

在大多数情况下，节点控制器将逐出速率限制为每秒--node-eviction-rate（默认值为0.1），这意味着每10秒不会从超过1个节点上逐出pod。

当给定可用性区域中的节点不正常时，节点驱逐行为会更改。节点控制器同时检查区域中有多少百分比的节点不正常（NodeReady条件为ConditionUnknown或ConditionFalse）：

* 如果不健康节点的分数至少为--unhealthy-zone-threshold（默认值为0.55），则驱逐率会降低。
* 如果集群很小（即具有小于或等于--large-cluster-size-threshold节点-默认值为50），则驱逐将停止。
* 否则，驱逐速率会降低为--secondary-node-eviction-rate（默认值为0.01）/秒。

每个可用区都实施这些策略的原因是，一个可用区可能会与主分区分开，而其他可用区仍保持连接。如果您的集群没有跨越多个云提供商可用性区域，则只有一个可用性区域（即整个集群）。

将节点分布在各个可用区域上的一个关键原因是，当一个整个区域出现故障时，可以将工作负载转移到运行状况良好的区域。 因此，如果区域中的所有节点都不健康，则节点控制器将以--node-eviction-rate的正常速率逐出。 当所有区域都完全不健康时（即群集中没有健康的节点），便是最极端的情况。 在这种情况下，节点控制器假定主连接存在问题，并停止所有逐出，直到恢复某些连接为止。

节点控制器还负责驱逐在具有NoExecute异味的节点上运行的Pod，除非这些Pod容忍该异味。 节点控制器还会添加与节点问题（例如，节点不可达或未就绪）相对应的污点。 这意味着调度程序不会将Pod放置在不正常的节点上。

警告：kubectl警戒线将一个节点标记为“不可调度”，这具有服务控制器从先前符合资格的任何LoadBalancer节点目标列表中删除该节点的副作用，从而有效地从警戒节点中删除了传入的负载均衡器流量。

### 节点容量

节点对象跟踪有关节点资源容量的信息：例如，可用内存量和CPU数量。 自行注册的节点会在注册过程中报告其容量。 如果手动添加节点，则在添加节点时需要设置其容量信息。

Kubernetes调度程序确保节点上所有Pod都有足够的资源。 调度程序检查节点上容器请求的总和不大于节点的容量。 该请求总数包括由kubelet管理的所有容器，但不包括由容器运行时直接启动的任何容器，也排除了在kubelet控件之外运行的任何进程。

## 节点拓扑结构

如果启用了TopologyManager功能门，则kubelet可以在做出资源分配决策时使用拓扑提示。 有关更多信息，请参见控制节点上的拓扑管理策略。

### 优雅的节点关机

如果启用了GracefulNodeShutdown功能门，则kubelet会尝试检测节点系统关闭并终止在节点上运行的Pod。 Kubelet确保在节点关闭期间，容器遵循正常的容器终止过程。

启用GracefulNodeShutdown功能门后，kubelet将使用systemd抑制器锁定来将节点关闭延迟给定的持续时间。 在关闭期间，kubelet分两个阶段终止pod：

* 终止在节点上运行的常规Pod。
* 终止在节点上运行的关键Pod。

优美的节点关闭功能配置了两个KubeletConfiguration选项：

* ShutdownGracePeriod：
  * 指定节点应延迟关闭的总时间。 这是常规和关键Pod终止Pod的总宽限期。
* ShutdownGracePeriodCriticalPods：
  * 指定在节点关闭期间用于终止关键Pod的持续时间。 这应该小于ShutdownGracePeriod。

例如，如果ShutdownGracePeriod = 30s，而ShutdownGracePeriodCriticalPods = 10s，则kubelet将使节点关闭延迟30秒。 在关闭期间，将保留前20（30-10）秒以正常终止正常Pod，而保留最后10秒以终止关键Pod。
