# 控制器

在机器人技术和自动化领域，控制回路是一个非终止回路，用于调节系统状态。

控制回路的一个示例：房间中的恒温器

当您设定温度时，即告诉恒温器您想要的状态。 实际的室温是当前状态。 恒温器通过打开或关闭设备来使当前状态更接近所需状态。

在Kubernetes中，控制器是控制回路，它们监视集群的状态，然后在需要时进行更改或请求更改。 每个控制器都尝试将当前群集状态移动到更接近所需状态。

## 控制器模式

控制器跟踪至少一种Kubernetes资源类型。 这些对象的spec字段表示所需的状态。 该资源的控制器负责使当前状态更接近于所需状态。

控制器可以自行执行操作； 更常见的是，在Kubernetes中，控制器会将消息发送给具有有用副作用的API服务器。 您将在下面看到此示例。

### 同过API Server控制

Job控制器是Kubernetes内置控制器的一个示例。 内置控制器通过与集群API服务器进行交互来管理状态。

Job是一个Kubernetes资源，它运行Pod或可能是多个Pod来执行任务然后停止。

一旦调度，Pod对象将成为kubelet所需状态的一部分。

当作业控制器看到一个新任务时，它确保在群集中的某个位置，一组节点上的kubelet运行正确数量的Pod以完成工作。 Job控制器本身不会运行任何Pod或容器。 而是，作业控制器告诉API服务器创建或删除Pod。 控制平面中的其他组件根据新信息起作用（有新的Pod计划和运行），最终工作完成了。

创建新作业后，所需的状态是该作业要完成。 Job控制器使该Job的当前状态更接近于您想要的状态：创建Pod来完成您要对该Job进行的工作，从而使Job接近完成。

控制器还更新配置它们的对象。 例如：完成作业的工作后，作业控制器将更新该作业对象以将其标记为“完成”。

这有点像某些恒温器如何关闭灯以指示您的房间现在处于您设定的温度。

### 直接控制

与Job相比，某些控制器需要对集群外部的内容进行更改。

例如，如果您使用控制循环来确保集群中有足够的节点，则该控制器需要当前集群之外的内容以在需要时设置新的节点。

与外部状态进行交互的控制器从API服务器中找到所需的状态，然后直接与外部系统进行通信以使当前状态更加紧密。

实际上有一个控制器可以水平扩展集群中的节点

这里的重点是控制器进行一些更改以实现所需的状态，然后将当前状态报告回群集的API服务器。 其他控制回路可以观察报告的数据并采取自己的行动。

在恒温器示例中，如果房间很冷，则另一个控制器可能还会打开防冻加热器。 在Kubernetes集群中，控制平面通过扩展Kubernetes来实现，从而间接与IP地址管理工具，存储服务，云提供商API和其他服务配合使用。

## 期望状态与当前状态

Kubernetes采用云原生系统视图，并能够处理不断变化的情况。

随着工作的进行，您的集群可能随时随地发生变化，并且控制环会自动修复故障。 这意味着，您的群集可能永远都无法达到稳定状态。

只要您的集群的控制器正在运行并且能够进行有用的更改，总体状态是否稳定都没有关系。

## 设计

作为其设计宗旨，Kubernetes使用许多控制器，每个控制器管理集群状态的特定方面。 最常见的是，特定的控制环（控制器）使用一种资源作为其所需状态，并使用另一种资源进行管理以使该所需状态发生。 例如，作业的控制器跟踪作业对象（以发现新工作）和Pod对象（以运行作业，然后查看工作何时完成）。 在这种情况下，其他作业将创建作业，而作业控制器将创建Pod。

使用简单的控制器而不是一组相互链接的单片式控制回路很有用。 控制器可能会失败，因此Kubernetes旨在解决这一问题。

可以有多个控制器创建或更新相同类型的对象。 在幕后，Kubernetes控制器确保仅关注与控制资源链接的资源。

例如，您可以具有“部署”和“作业”； 这些都创造了豆荚。 作业控制器不会删除您的Deployment创建的Pod，因为控制器可以使用某些信息（标签）来区分这些Pod。

## 运行控制器的方式

Kubernetes带有一组在kube-controller-manager内部运行的内置控制器。 这些内置控制器提供了重要的核心行为。

Deployment控制器和Job控制器是Kubernetes本身的一部分（“内置”控制器）控制器的示例。 Kubernetes允许您运行弹性控制平面，这样，如果任何内置控制器发生故障，控制平面的另一部分将接管工作。

您可以找到在控制平面之外运行的控制器来扩展Kubernetes。 或者，如果需要，您可以自己编写一个新的控制器。 您可以将自己的控制器作为一组Pod运行，也可以在Kubernetes外部运行。 最合适的选择取决于特定控制器的功能。

