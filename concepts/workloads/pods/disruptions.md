# 破坏

本指南面向希望构建高可用应用的应用管理员，并需要了解什么样的破坏可能发生在pod上。

## 自愿和非自愿中断

pods不会主动消失，直到某人删除，或者存在不可避免的硬件和系统软件错误。

对于应用来说，我们称呼这些不可避免的场景为非自愿中断。例如：
* 支持该节点的物理机发生故障
* 集群管理员失误删除虚拟机实例
* 云厂商或者hypervisor错误，导致虚拟机实例消失
* 内核异常
* 由于网络划分导致节点从集群中消失
* 由于节点资源不足将pod驱逐

除了资源不足的场景，大多数用户都对所有的场景熟悉，这些并不是kubernete特有的。

我们称呼其他的场景为自愿中断。这些包含程序拥有者的初始化动作，以及集群管理员的初始化动作，典型的程序拥有者的动作包含：
* 删除deployment或者其他的管理pod的控制器
* 更新一个deployment导致重启
* 直接删除一个pod

集群管理员的动作包含：
* 清空节点以维修或者升级
* 排空节点，以缩小集群
* 从一个节点移除pod，以供其他事物使用节点

这些动作可能由集群管理员直接操作，或者由集群管理员定义的自动程序执行，或者由集群主机提供商执行。

请您的群集管理员或咨询您的云提供商或发行文档，以确定是否为您的群集启用了任何自愿中断源。 如果未启用任何一项，则可以跳过创建Pod中断预算的操作。

注意：并非所有自愿中断都受到Pod中断预算的限制。 例如，删除部署或Pod将绕过Pod中断预算。

## 应对破坏

以下是几种应对被动中断的方法：
* 保证你的pod请求所需的资源
* 如果你的程序需要更高的可用性，使用多副本的方式
* 对于更高的可用性要求，可以将程序分布到跨区域

自愿中断的频率各不相同。 在基本的Kubernetes集群上，没有自动的自愿中断（只有用户触发的中断）。 但是，您的群集管理员或主机提供商可能会运行一些其他服务，这些服务会导致自愿中断。 例如，推出节点软件更新可能会导致自愿中断。 同样，群集（节点）自动缩放的某些实现可能会导致对碎片整理和紧凑型节点的自愿中断。 您的集群管理员或主机提供商应已记录了预期的自愿中断级别（如果有）。 某些配置选项，例如在pod规范中使用PriorityClasses，也可能导致自愿（和非自愿）中断。

## pod中断徽章

即便当你面对频繁的主动中断的时候，kubernetes为你运行高可用的程序提供了特性。

作为一个程序的拥有者，你可以为每个应用创建pod中断徽章PDB。PDB限制了副本程序持续的主动中断次数。例如，一个基于quorum的应用程序，希望确保运行中的副本数量永远不会少于quorum需要的数量。一个前端web端点希望确保副本的数量永远不要其余总量的一定百分比。

集群管理员和主机提供商应当使用工具决定遵循哪个PDB，通过调用驱逐API，而不是直接删除pod和deployments。

例如，`kubectl drain`子命令允许您标记一个node为脱离服务。当你运行`kubectl drain`的时候，该工具试图驱逐该节点的所有pods。该kubectl以你名义提交的驱逐请求可能会被暂时的拒绝，所以该工具阶段性的重试失败的请求，直到目标节点的所有pod都销毁，或者配置的超时时间到达。

一个PDB指定了一个应用可以容忍副本的数量，相对于它打算拥有的数量。例如，一个deploymen定义`.spec.replicas: 5`表示在任意给定时间拥有5个副本。如果此处的PDB定义为4个同时，则驱逐API会允许同时发生自愿中断1个。

