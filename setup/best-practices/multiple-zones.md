# 多域环境运行

本节讲解在k8s中运行多个环境。

## 背景

经过设计，k8s集群可以应对多个故障域问题的情况，一般来说这些域对应到逻辑组中叫做`region`。主流的云平台定义了地域为一系列故障域的集合，并提供一系列的特色服务：同一地域中，每个故障域提供相同的接口和服务。

## 控制平面行为

所有的控制平面组件都支持作为可互换资源池运行，每个组件都可被复制。部署集群控制平面时，请将控制平面组件的副本放置在多个故障区域中。如果可用性是一个重要问题，请选择至少三个故障区域，并在至少三个故障区域中复制每个单独的控制平面组件（API服务器，调度程序等，群集控制器管理器）。如果您使用了云厂商提供的控制器，您也应当保证故障域有多个副本。
**注意** Kubernetes不为API服务器端点提供跨区域弹性。 您可以使用各种技术来提高群集API服务器的可用性，包括DNS轮询，SRV记录或具有运行状况检查的第三方负载平衡解决方案。

## 节点行为

节点启动时，每个节点上的kubelet会自动的将标签添加到代表kubernetes api中该特定的kubelet的Node对象。这些标签信息可以包含域信息。如果你的集群跨多个域分布，建议将节点标签搭配pod扩展约束一起使用，以控制pod如何在整个故障域之间分布。这样操作可以使得调度器将pod调度到一个理想的可用性状态，减少相关的出错影响整个工作负载带来的风险。例如，条件允许时，你可以设置限制，将3个副本的`StatefulSet`应用部署到不同的域中。你可以生命性的定义它，而无需显示定义每个工作负载正在使用哪些域。

## 节点的跨域分布

k8s本身并不会为您创建节点，你需要自己来执行此操作，或者使用注入`Cluster API`之类的工具来管理你的节点。使用`Cluster API`之类的工具可以定义一系列机器集合，这些机器集合作为工作节点分布运行在多个故障域中，也会根据规则自愈集群。

## 管理域为pod的划分

您可以为你创建的pod设置节点标签限制器，同理，在工作负载类的资源的pod模板中也可以这样操作，例如`Deployment`,`StatefulSet`,`Job`。

## 存储的跨域

当持久化卷创建时，管理控制器会自动的为关联到域中的持久化卷增加`PersistentVolumeLabel`标签。调度器随后会做确认，通过`NoVolumeZoneConflict`来确认pod可以声明一个同域中的持久化卷。你可以为持久化卷声明指定一个存储控制器，该类指定该类中的存储可以使用的故障域。

## 网络

k8s本身并不支持无感网络，您可以使用网络插件来配置集群网络，并且该网络解决方案可能具有特定于区域的元素。例如，如果您的云服务提供商支持`type=LoadBalancer`的代理，则负载均衡器可能仅将流量发送到与处理同一连接的负载均衡器的同一个区域中的pod。关于这点，请查阅云厂商的文档。对于自定义或者本地部署的情况，也有类似的注意事项。`Service`和`Ingress`的行为，包括如何处理不同的故障与，很大程度上取决于您的集群的部署方式。

## 错误恢复

当部署集群的时候，你也许需要考虑下是否以及如何让你的集群可以在多个故障域同时离线的情况下恢复，例如，你依赖于每个故障域至少有一个运行pod的节点吗？要知道，任何集群成对的工作不会依赖于集群中至少一个健康节点。例如，如果所有节点都处于不健康状态，你也许需要运行一个修复任务，这个任务会需要一个特殊的容忍度，才能够实现修复至少一个节点的服务。针对这个问题，k8s并没有给出解答，但是这仍然是需要考量的。

